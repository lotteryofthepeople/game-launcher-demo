<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Game Launcher</title>
    <style>
        body {
            font-family: monospace;
            font-size: 14pt
        }
    </style>
    <script>
        let playerBalance = 100
        let remainingTickets = 50
        const tickets = {}
        const GAME_ID = 1
        const TICKET_COST = 1.01

        /** Purchase a new blockchain ticket for the gameId */
        const buyTicket = (gameId) => {
            console.log('launcher', `buyTicket(gameId: ${gameId})`)
            return mockTicket(gameId)
        }

        const mockTicket = (gameId) => {
            playerBalance = roundHalfEven(playerBalance - TICKET_COST)
            remainingTickets -= 1
            const ticket = {
                gameId: gameId,
                ticketId: Math.round(Math.random() * 1000000),
                ticketCost: TICKET_COST,
                outcomes: [500, 979, 999, 1000],
                payouts:  [0, 1, 3, 75],
                rng: Math.round(Math.random() * 999) + 1,
                played: false,
                balance: playerBalance,
                remainingTickets: remainingTickets
            }
            tickets[ticket.ticketId] = ticket
            return ticket
        }

        const addToPlayerBalance = (change) => {
            playerBalance = roundHalfEven(playerBalance + change)
            console.log('launcher', `balanceChange(${playerBalance})`)

            sendBalanceToGameUi(playerBalance)
        }

        const ticketValue = (ticket) => {
            const resultInd = ticket.outcomes.findIndex((value) => { // 0, 1, 2, 3
                return ticket.rng <= value
            })
            return ticket.payouts[resultInd]
        }

        /** Claim the prize for a game on the blockchain */
        const claimPrize = (gameId, ticketId) => {
            console.log('launcher', `claimPrize(gameId: ${gameId}, ticketId: ${ticketId})`)

            const ticket = tickets[ticketId]
            if (ticket['claimed'])
                return

            const value = ticketValue(ticket)
            if (value)
                addToPlayerBalance(value)
            ticket['claimed'] = true
        }

        /** Save the game and ticket specific progress information */
        const saveGameProgress = (gameId, ticketId, data) => {
            console.log('launcher', `saveGameProgress(gameId: ${gameId}, ticketId: ${ticketId}, data: ${data})`)
        }

        /** Send game state 'ticket' to the user interface in an async message */
        const sendTicketToGameUi = (ticket) => {
            const game = document.getElementById("game_content")
            game.contentWindow.postMessage({action: 'play', ticket}, '*')
        }

        /** Send updated balance the user interface in an async message */
        const sendBalanceToGameUi = (balance) => {
            const game = document.getElementById("game_content")
            game.contentWindow.postMessage({action: 'balanceChange', balance}, '*')
        }

        window.onmessage = function (e) {
            if (e.data?.action === 'buyTicket') {
                const ticket = buyTicket(e.data?.gameId)

                sendTicketToGameUi(ticket)
            } else if (e.data?.action === 'claimPrize') {
                claimPrize(e.data?.gameId, e.data?.ticketId)
            } else if (e.data?.action === 'saveGameProgress') {
                saveGameProgress(e.data?.gameId, e.data?.ticketId, e.data?.data)
            } else if (e.data?.action === 'readyToPlay') {
                readyToPlay(GAME_ID)
            } else {
                console.warn('launcher', 'Unrecognized message', e.data)
            }
        }

        const readyToPlay = (gameId) => {
            console.log('launcher', 'readyToPlay')

            // generate new ticket if the clicked one is already played
            sendTicketToGameUi(mockTicket(gameId))
        }

        const gameSizeChanged = () => {
            const gameFrame = document.getElementById("game_content")
            const newHeight = gameFrame.contentWindow.document.body.scrollHeight
                + parseInt(getComputedStyle(gameFrame).marginTop)
                + parseInt(getComputedStyle(gameFrame).marginBottom)
            gameFrame.height = newHeight + "px"
        }

        const launcherSizeChanged = () => {
            const gameFrame = document.getElementById("game_content")
            gameFrame.style.aspectRatio = "" + window.innerWidth / window.innerHeight
            gameFrame.height = ""
        }

        const registerGameSizeHandler = () => {
            const gameFrame = document.getElementById("game_content")
            gameFrame.contentWindow.onresize = gameSizeChanged
            window.onresize = launcherSizeChanged

            launcherSizeChanged()
        }

        const roundHalfEven = (n) => {
            return Math.round(n*100)/100;
        }
    </script>
</head>
<body onload="registerGameSizeHandler()">
Embedded Game UI:
<div>
    <iframe
            src="index.html"
            id="game_content"
            title="Game"
            scrolling="no"
            frameBorder="0"
            style='width: 100%; overflow: hidden; border: none'
    ></iframe>
</div>
</body>
</html>